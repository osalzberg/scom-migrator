<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCOM to Azure Monitor Migration Tool</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230078d4' rx='15' width='100' height='100'/><path fill='white' d='M25 65 L45 35 L55 50 L75 25 L75 75 L25 75 Z'/><circle fill='%2350e3c2' cx='75' cy='25' r='8'/></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== DESIGN TOKENS ===== */
        :root {
            /* Primary palette */
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: #eff6ff;
            --primary-muted: #93c5fd;
            
            /* Semantic colors */
            --success: #059669;
            --success-light: #ecfdf5;
            --success-border: #a7f3d0;
            --warning: #d97706;
            --warning-light: #fffbeb;
            --warning-border: #fde68a;
            --danger: #dc2626;
            --danger-light: #fef2f2;
            --danger-border: #fecaca;
            --info: #0891b2;
            --info-light: #ecfeff;
            
            /* Neutrals */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Surfaces */
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --bg-elevated: #ffffff;
            --border-default: #e5e7eb;
            --border-subtle: #f3f4f6;
            
            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.04);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.08), 0 8px 10px -6px rgba(0,0,0,0.04);
            
            /* Spacing (8px scale) */
            --sp-1: 4px;
            --sp-2: 8px;
            --sp-3: 12px;
            --sp-4: 16px;
            --sp-5: 20px;
            --sp-6: 24px;
            --sp-8: 32px;
            --sp-10: 40px;
            --sp-12: 48px;
            --sp-16: 64px;
            
            /* Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
            
            /* Typography */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'SF Mono', 'Fira Code', 'Cascadia Code', Consolas, monospace;
        }
        
        *, *::before, *::after { box-sizing: border-box; }
        
        body {
            font-family: var(--font-sans);
            background: var(--bg-page);
            color: var(--gray-800);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
            font-size: 14px;
        }
        
        /* ===== TOP NAV BAR ===== */
        .top-bar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-default);
            padding: var(--sp-4) 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
            background: rgba(255,255,255,0.92);
        }
        
        .top-bar-inner {
            max-width: 960px;
            margin: 0 auto;
            padding: 0 var(--sp-6);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .top-bar .brand {
            display: flex;
            align-items: center;
            gap: var(--sp-3);
            text-decoration: none;
            color: var(--gray-900);
        }
        
        .top-bar .brand-icon {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        
        .top-bar .brand-text {
            font-weight: 600;
            font-size: 15px;
            letter-spacing: -0.01em;
        }
        
        .top-bar .brand-badge {
            font-size: 10px;
            font-weight: 500;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            letter-spacing: 0.02em;
        }
        
        /* ===== MAIN LAYOUT ===== */
        .main-container {
            max-width: 960px;
            margin: 0 auto;
            padding: var(--sp-10) var(--sp-6) var(--sp-16);
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            background: transparent;
            border-bottom: 1px solid var(--border-default);
            padding: var(--sp-5) var(--sp-6);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
            color: var(--gray-800);
        }
        
        .card-header h4 {
            font-weight: 600;
            margin: 0;
            font-size: 16px;
        }
        
        .card-header h6 {
            font-weight: 600;
            margin: 0;
            font-size: 14px;
            color: var(--gray-700);
        }
        
        .card-body {
            padding: var(--sp-6);
        }
        
        /* ===== PAGE HEADER ===== */
        .page-header {
            text-align: center;
            margin-bottom: var(--sp-10);
        }
        
        .page-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.02em;
            margin-bottom: var(--sp-2);
        }
        
        .page-header p {
            color: var(--gray-500);
            font-size: 15px;
            margin: 0;
        }
        
        /* ===== UPLOAD ZONE ===== */
        .upload-zone {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-xl);
            padding: var(--sp-16) var(--sp-8);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--gray-50);
        }
        
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        
        .upload-zone.dragover {
            border-style: solid;
            box-shadow: 0 0 0 4px rgba(37,99,235,0.1);
        }
        
        .upload-zone .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--sp-6);
            background: var(--primary-light);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upload-zone .upload-icon i {
            font-size: 28px;
            color: var(--primary);
        }
        
        .upload-zone h5 {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: var(--sp-1);
        }
        
        .upload-zone p {
            color: var(--gray-500);
            font-size: 13px;
        }
        
        /* ===== BUTTONS ===== */
        .btn-azure {
            background: var(--primary);
            border: none;
            color: white;
            font-weight: 500;
            padding: var(--sp-3) var(--sp-6);
            border-radius: var(--radius-md);
            transition: all 0.15s ease;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-azure:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37,99,235,0.25);
            color: white;
        }
        
        .btn-azure:active {
            transform: translateY(0);
        }
        
        .btn-azure.btn-lg {
            padding: var(--sp-4) var(--sp-8);
            font-size: 15px;
        }
        
        .btn-azure:disabled, .btn-azure[disabled] {
            background: var(--gray-300);
            color: var(--gray-500);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Override Bootstrap buttons for consistency */
        .btn-success {
            background: var(--success) !important;
            border-color: var(--success) !important;
            border-radius: var(--radius-md);
            font-weight: 500;
        }
        .btn-success:hover {
            background: #047857 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5,150,105,0.25);
        }
        
        .btn-primary {
            background: var(--primary) !important;
            border-color: var(--primary) !important;
            border-radius: var(--radius-md);
            font-weight: 500;
        }
        .btn-primary:hover {
            background: var(--primary-hover) !important;
        }
        
        .btn-outline-secondary {
            border-color: var(--gray-300);
            color: var(--gray-600);
            border-radius: var(--radius-md);
            font-weight: 500;
        }
        .btn-outline-secondary:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
            color: var(--gray-700);
        }
        
        .btn-outline-primary {
            border-color: var(--primary);
            color: var(--primary);
            border-radius: var(--radius-md);
            font-weight: 500;
        }
        .btn-outline-primary:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateY(-1px);
        }
        
        /* ===== RESULTS ===== */
        .result-section {
            display: none;
            animation: slideIn 0.35s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== STAT CARDS ===== */
        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--sp-6) var(--sp-5);
            text-align: center;
            transition: all 0.2s ease;
            border: 1px solid var(--border-default);
            position: relative;
        }
        
        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .stat-card .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--sp-3);
            font-size: 18px;
        }
        
        .stat-card .stat-icon.blue   { background: var(--primary-light); color: var(--primary); }
        .stat-card .stat-icon.green  { background: var(--success-light); color: var(--success); }
        .stat-card .stat-icon.orange { background: var(--warning-light); color: var(--warning); }
        
        .stat-card h3 {
            font-size: 36px;
            font-weight: 700;
            margin: 0 0 var(--sp-1);
            letter-spacing: -0.02em;
            line-height: 1;
        }
        
        .stat-card small {
            color: var(--gray-500);
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        
        .complexity-simple { color: var(--success); }
        .complexity-moderate { color: var(--warning); }
        .complexity-complex { color: var(--danger); }
        .complexity-manual { color: var(--gray-500); }
        
        /* ===== MAPPING CARDS ===== */
        .mapping-card {
            border: 1px solid var(--border-default);
            border-left: 3px solid var(--primary);
            margin-bottom: var(--sp-3);
            transition: all 0.15s ease;
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .mapping-card:hover {
            box-shadow: var(--shadow-sm);
            border-left-color: var(--primary-hover);
        }
        
        /* ===== KQL CODE BLOCKS ===== */
        .kql-code {
            background: var(--gray-900);
            color: #e5e7eb;
            padding: var(--sp-5);
            border-radius: var(--radius-md);
            font-family: var(--font-mono);
            font-size: 13px;
            overflow-x: auto;
            border: 1px solid var(--gray-700);
        }
        
        /* ===== LOADING ===== */
        .loading { display: none; }
        
        .spinner-border {
            width: 48px;
            height: 48px;
            border-width: 3px;
            color: var(--primary) !important;
        }
        
        /* ===== BADGES ===== */
        .badge-target {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-weight: 500;
        }
        
        /* ===== PREREQ LIST ===== */
        .prereq-list li {
            padding: var(--sp-3) 0;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            font-size: 13px;
            color: var(--gray-600);
        }
        
        .prereq-list li:last-child { border-bottom: none; }
        
        #fileInput { display: none; }
        label[for="fileInput"] { cursor: pointer; }
        
        /* ===== ALERT BLOCKS ===== */
        .alert-info {
            background: var(--info-light);
            border: 1px solid #a5f3fc;
            border-left: 3px solid var(--info);
            border-radius: var(--radius-md);
            color: var(--gray-700);
            font-size: 13px;
        }
        
        .alert-success {
            background: var(--success-light);
            border: 1px solid var(--success-border);
            border-left: 3px solid var(--success);
            border-radius: var(--radius-md);
            color: var(--gray-700);
            font-size: 13px;
        }
        
        .alert-warning {
            background: var(--warning-light) !important;
            border: 1px solid var(--warning-border) !important;
            border-left: 3px solid var(--warning) !important;
            border-radius: var(--radius-md) !important;
            color: var(--gray-700);
            font-size: 13px;
        }
        
        .alert-danger {
            background: var(--danger-light);
            border: 1px solid var(--danger-border);
            border-left: 3px solid var(--danger);
            border-radius: var(--radius-md);
            color: var(--gray-700);
            font-size: 13px;
        }
        
        /* ===== SECTION CARDS (Easy / Manual) ===== */
        .card.border-success {
            border: 1px solid var(--success-border) !important;
        }
        .card.border-success .card-header {
            background: var(--success-light) !important;
            color: var(--gray-800) !important;
            border-bottom: 1px solid var(--success-border);
        }
        
        .card.border-warning {
            border: 1px solid var(--warning-border) !important;
        }
        .card.border-warning .card-header {
            background: var(--warning-light) !important;
            color: var(--gray-800) !important;
            border-bottom: 1px solid var(--warning-border);
        }
        
        .card.border-danger {
            border: 1px solid var(--danger-border) !important;
        }
        .card.border-danger .card-header {
            background: var(--danger-light) !important;
            color: var(--gray-800) !important;
            border-bottom: 1px solid var(--danger-border);
        }
        
        .card-header.bg-light {
            background: var(--gray-50) !important;
            color: var(--gray-700);
        }
        
        /* ===== PROGRESS BAR ===== */
        .progress {
            background: var(--gray-100);
            border-radius: var(--radius-full);
            overflow: hidden;
            border: 1px solid var(--border-default);
        }
        
        .progress-bar {
            border-radius: var(--radius-full);
            transition: width 0.8s ease;
        }
        
        .progress-bar.bg-success { background: var(--success) !important; }
        .progress-bar.bg-warning { background: var(--warning) !important; }
        .progress-bar.bg-danger  { background: var(--danger) !important; }
        
        /* ===== DETAILS / SUMMARY ===== */
        details summary {
            cursor: pointer;
            user-select: none;
            padding: var(--sp-2);
            border-radius: var(--radius-sm);
            transition: background 0.15s ease;
            font-size: 13px;
        }
        
        details summary:hover { background: var(--gray-50); }
        details[open] summary { margin-bottom: var(--sp-2); font-weight: 600; }
        
        /* ===== FOOTER ===== */
        .footer-section {
            margin-top: var(--sp-12);
            padding-top: var(--sp-8);
            border-top: 1px solid var(--border-default);
            text-align: center;
        }
        
        .footer-text {
            text-align: center;
            color: var(--gray-500);
            font-size: 13px;
        }
        
        .footer-links .btn {
            font-size: 12px;
            border-radius: var(--radius-full);
        }
        
        /* ===== BTN GROUP FILTERS ===== */
        .btn-group .btn {
            border-radius: var(--radius-md);
            margin: 0 2px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .btn-group .btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* ===== FLOATING DOWNLOAD ===== */
        .floating-download-btn {
            position: fixed;
            top: var(--sp-5);
            right: var(--sp-5);
            z-index: 1050;
            display: none;
            animation: slideInRight 0.3s ease-out;
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-full);
            padding: var(--sp-3) var(--sp-6);
            font-weight: 600;
            font-size: 13px;
        }
        
        .floating-download-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-xl);
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* ===== ACCORDION ===== */
        .accordion-item {
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md) !important;
            margin-bottom: var(--sp-2);
            overflow: hidden;
        }
        
        .accordion-button {
            font-size: 13px;
            font-weight: 500;
            padding: var(--sp-4);
        }
        
        .accordion-button:not(.collapsed) {
            background: var(--gray-50);
            color: var(--gray-800);
            box-shadow: none;
        }
        
        .accordion-button:focus {
            box-shadow: none;
            border-color: var(--primary);
        }
        
        /* ===== DOWNLOAD GRID ===== */
        .download-grid .btn {
            border-radius: var(--radius-md);
            font-size: 12px;
            transition: all 0.15s ease;
        }
        
        .download-grid .btn:hover {
            transform: translateY(-1px);
        }
        
        .download-grid .badge {
            font-size: 10px;
            font-weight: 500;
        }
        
        /* ===== AUTHOR CARD ===== */
        .author-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
        }
        
        /* ===== DISCLAIMER ===== */
        .disclaimer-block {
            background: var(--gray-50);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: var(--sp-5);
            margin-bottom: var(--sp-8);
        }
        
        .disclaimer-block p {
            font-size: 11px;
            color: var(--gray-500);
            line-height: 1.5;
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .stat-card h3 { font-size: 28px; }
            .upload-zone { padding: var(--sp-10) var(--sp-4); }
            .main-container { padding: var(--sp-6) var(--sp-4) var(--sp-12); }
            .top-bar .brand-badge { display: none; }
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-bar">
        <div class="top-bar-inner">
            <a class="brand" href="#">
                <div class="brand-icon"><i class="bi bi-cloud-arrow-up"></i></div>
                <span class="brand-text">SCOM Migrator</span>
                <span class="brand-badge">v1.16.0</span>
            </a>
            <div>
                <a href="https://github.com/osalzberg/scom-migrator" target="_blank" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-github me-1"></i>GitHub
                </a>
            </div>
        </div>
    </nav>
    
    <!-- Floating Download Button (shown after analysis) -->
    <button class="btn btn-success floating-download-btn" id="floatingDownloadBtn" onclick="scrollToDownload()">
        <i class="bi bi-download me-2"></i>Jump to Download
    </button>
    
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>SCOM to Azure Monitor</h1>
            <p>Upload a Management Pack to analyze and generate migration artifacts</p>
        </div>
        
        <div class="card">
            <div class="card-body">
                <!-- Upload Section -->
                <div id="uploadSection">
                    <div class="upload-zone" id="dropZone">
                        <div class="upload-icon">
                            <i class="bi bi-file-earmark-arrow-up"></i>
                        </div>
                        <h5>Drop Management Pack Here</h5>
                        <p class="mb-4">or click to browse files</p>
                        <label for="fileInput" class="btn btn-azure">
                            <i class="bi bi-folder2-open me-2"></i>Browse Files
                        </label>
                        <p class="mt-4 mb-0" style="font-size: 12px; color: var(--gray-400);">
                            <i class="bi bi-info-circle me-1"></i>
                            Supports .xml Management Pack files (max 50MB)
                        </p>
                    </div>
                    <input type="file" id="fileInput" accept=".xml" onchange="handleFileSelect(event)">
                    
                    <div class="mt-3" id="selectedFile" style="display: none;">
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="bi bi-file-earmark-code me-2 fs-5"></i>
                            <span id="fileName" class="flex-grow-1"></span>
                            <button type="button" class="btn-close" onclick="clearFile()"></button>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-azure btn-lg" id="analyzeBtn" onclick="analyzeFile()" disabled>
                            <i class="bi bi-search me-2"></i>Analyze Management Pack
                        </button>
                    </div>
                </div>
                        
                        <!-- Loading Section -->
                        <div class="loading text-center py-5" id="loadingSection">
                            <div class="spinner-border text-primary mb-4" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5 class="mb-2">Analyzing Management Pack...</h5>
                            <p class="text-muted">Parsing XML, analyzing components, and generating recommendations</p>
                        </div>
                        
                        <!-- Results Section -->
                        <div class="result-section" id="resultSection">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0">
                                    <i class="bi bi-clipboard-data me-2"></i>
                                    Analysis Results
                                </h5>
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetForm()">
                                    <i class="bi bi-arrow-left me-1"></i>Analyze Another
                                </button>
                            </div>
                            
                            <!-- MP Info -->
                            <div class="alert alert-info mb-4">
                                <h6 class="mb-1 fw-bold" id="mpName"></h6>
                                <small id="mpVersion"></small>
                            </div>
                            
                            <!-- Migration Readiness -->
                            <div class="card mb-4 border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Migration Readiness</h6>
                                        <span class="badge bg-primary fs-6" id="readinessPercent">0%</span>
                                    </div>
                                    <div class="progress" style="height: 12px;">
                                        <div class="progress-bar bg-success" id="readinessBar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted mt-2 d-block" id="readinessText">Calculating...</small>
                                </div>
                            </div>
                            
                            <!-- Stats -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-4 col-sm-6">
                                    <div class="stat-card">
                                        <div class="stat-icon blue"><i class="bi bi-layers"></i></div>
                                        <h3 id="totalComponents" style="color: var(--primary);">0</h3>
                                        <small>Total Components</small>
                                    </div>
                                </div>
                                <div class="col-md-4 col-sm-6">
                                    <div class="stat-card">
                                        <div class="stat-icon green"><i class="bi bi-check-circle"></i></div>
                                        <h3 id="migratableCount" style="color: var(--success);">0</h3>
                                        <small>Easily Migratable</small>
                                    </div>
                                </div>
                                <div class="col-md-4 col-sm-6">
                                    <div class="stat-card">
                                        <div class="stat-icon orange"><i class="bi bi-exclamation-triangle"></i></div>
                                        <h3 id="manualCount" style="color: var(--warning);">0</h3>
                                        <small>Manual Review</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recommendations -->
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Key Recommendations</h6>
                                </div>
                                <div class="card-body">
                                    <div id="recommendations"></div>
                                </div>
                            </div>
                            
                            <!-- Prerequisites - Collapsible -->
                            <div class="card mb-4">
                                <div class="card-header bg-light" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#prerequisitesCollapse">
                                    <h6 class="mb-0 d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-list-check me-2"></i>Prerequisites</span>
                                        <i class="bi bi-chevron-down"></i>
                                    </h6>
                                </div>
                                <div class="collapse" id="prerequisitesCollapse">
                                    <div class="card-body">
                                        <ul class="list-unstyled mb-0" id="prerequisites"></ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Easily Migratable Components - INCLUDED IN DOWNLOAD -->
                            <div class="card mb-4 border-success" id="easyMigrationCard" style="display: none;">
                                <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#easyMigrationCollapse">
                                    <h6 class="mb-0">
                                        <i class="bi bi-check-circle me-2" style="color: var(--success);"></i>
                                        Auto-Migrated Components 
                                        <span class="badge" style="background: var(--success-light); color: var(--success);" id="easyCount">0</span>
                                    </h6>
                                    <div>
                                        <span class="badge" style="background: var(--success-light); color: var(--success);">Included in Download</span>
                                        <i class="bi bi-chevron-down ms-2"></i>
                                    </div>
                                </div>
                                <div class="collapse show" id="easyMigrationCollapse">
                                    <div class="card-body">
                                        <div class="alert alert-success mb-3">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>These components are covered by the downloaded ARM templates.</strong>
                                            Deploy the All-in-One template to set up alerts, DCRs, and workbooks for all these items.
                                        </div>
                                        <div id="easyMappings" style="max-height: 70vh; overflow-y: auto;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Components NOT Auto-Migrated -->
                            <div class="card mb-4 border-danger" id="manualReviewCard" style="display: none;">
                                <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#manualReviewCollapse">
                                    <h6 class="mb-0">
                                        <i class="bi bi-exclamation-octagon me-2" style="color: var(--danger);"></i>
                                        Requires Manual Migration
                                        <span class="badge" style="background: var(--danger-light); color: var(--danger);" id="manualCount2">0</span>
                                    </h6>
                                    <div>
                                        <span class="badge" style="background: var(--danger-light); color: var(--danger);">NOT in Download</span>
                                        <i class="bi bi-chevron-down ms-2"></i>
                                    </div>
                                </div>
                                <div class="collapse show" id="manualReviewCollapse">
                                    <div class="card-body">
                                        <div class="alert alert-danger mb-3">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            <strong>These components require manual implementation.</strong>
                                            They may involve custom scripts, complex logic, or unsupported features that need human review.
                                        </div>
                                        <div id="manualMappings" style="max-height: 70vh; overflow-y: auto;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- All Component Mappings - Collapsed by default -->
                            <div class="card mb-4">
                                <div class="card-header bg-light" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#allMappingsCollapse">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>All Component Mappings (Details)</h6>
                                        <i class="bi bi-chevron-down"></i>
                                    </div>
                                </div>
                                <div class="collapse" id="allMappingsCollapse">
                                    <div class="card-body">
                                        <div class="d-flex gap-2 flex-wrap align-items-center mb-3">
                                            <div class="input-group input-group-sm" style="width: 200px;">
                                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                                <input type="text" class="form-control" id="searchMappings" placeholder="Search..." oninput="searchMappings()">
                                            </div>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary active" onclick="filterMappings('all')">All</button>
                                                <button class="btn btn-outline-secondary" onclick="filterMappings('Monitor')">Monitors</button>
                                                <button class="btn btn-outline-secondary" onclick="filterMappings('Rule')">Rules</button>
                                                <button class="btn btn-outline-secondary" onclick="filterMappings('Discovery')">Discoveries</button>
                                            </div>
                                        </div>
                                        <div id="mappings" style="max-height: 500px; overflow-y: auto;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Download Section -->
                            <div class="card" id="downloadSection">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-download me-2"></i>Download & Deploy to Azure</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-warning mb-3">
                                        <div class="d-flex align-items-start">
                                            <i class="bi bi-exclamation-triangle-fill me-3 fs-5" style="color: var(--warning);"></i>
                                            <div>
                                                <strong>Deploy to Azure</strong>
                                                <p class="mb-0 small mt-1">
                                                    Before deploying, edit the template to set your workspace name and other parameters.
                                                    <strong>Always review and test in a non-production environment first.</strong>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- All-in-One Download -->
                                    <div class="mb-4">
                                        <button class="btn btn-success btn-lg w-100 d-flex align-items-center justify-content-center py-3" onclick="downloadArtifact('complete')">
                                            <i class="bi bi-download me-2" style="font-size: 1.5rem;"></i>
                                            <div class="text-start">
                                                <span class="fw-bold">Download All-in-One Template</span>
                                                <span class="d-block" style="font-size: 0.75rem; opacity: 0.9;">Single deployment with alerts, DCRs, workbook &amp; custom logs</span>
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <!-- Individual Downloads -->
                                    <p class="text-muted small mb-2"><i class="bi bi-grid me-1"></i>Or download individual templates:</p>
                                    <div class="row g-3 align-items-stretch">
                                        <div class="col-md-4 col-lg-2">
                                            <div class="d-grid h-100">
                                                <button class="btn btn-primary d-flex flex-column align-items-center justify-content-center py-3" onclick="downloadArtifact('arm')">
                                                    <i class="bi bi-cloud-upload mb-1"></i>
                                                    <span>ARM Template</span>
                                                    <span class="badge bg-light text-primary mt-1" style="font-size: 0.6rem;">Alert Rules</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4 col-lg-2">
                                            <div class="d-grid h-100">
                                                <button class="btn btn-primary d-flex flex-column align-items-center justify-content-center py-3" onclick="downloadArtifact('dcr')">
                                                    <i class="bi bi-collection mb-1"></i>
                                                    <span>DCR Template</span>
                                                    <span class="badge bg-light text-primary mt-1" style="font-size: 0.6rem;">Data Collection</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4 col-lg-2">
                                            <div class="d-grid h-100">
                                                <button class="btn btn-info text-white d-flex flex-column align-items-center justify-content-center py-3" onclick="downloadArtifact('workbook')">
                                                    <i class="bi bi-bar-chart-line mb-1"></i>
                                                    <span>Workbook</span>
                                                    <span class="badge bg-light text-info mt-1" style="font-size: 0.6rem;">Dashboard</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4 col-lg-2">
                                            <div class="d-grid h-100">
                                                <button class="btn btn-warning text-dark d-flex flex-column align-items-center justify-content-center py-3" onclick="downloadArtifact('customlog')">
                                                    <i class="bi bi-file-text mb-1"></i>
                                                    <span>Custom Log DCR</span>
                                                    <span class="badge bg-dark text-warning mt-1" style="font-size: 0.6rem;">Script Output</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4 col-lg-2">
                                            <div class="d-grid h-100">
                                                <button class="btn btn-outline-secondary d-flex flex-column align-items-center justify-content-center py-3" onclick="downloadArtifact('csv')">
                                                    <i class="bi bi-filetype-csv mb-1"></i>
                                                    <span>CSV Export</span>
                                                    <span class="badge bg-secondary mt-1" style="font-size: 0.6rem;">Planning</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4 col-lg-2" id="scriptGuideButtonContainer" style="display: none;">
                                            <div class="d-grid h-100">
                                                <button class="btn btn-outline-dark d-flex flex-column align-items-center justify-content-center py-3" onclick="showScriptGuidance()">
                                                    <i class="bi bi-code-square mb-1"></i>
                                                    <span>Script Guide</span>
                                                    <span class="badge bg-dark mt-1" style="font-size: 0.6rem;">Migration</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Script Migration Guidance Modal Trigger -->
                                    <div id="scriptGuidanceSection" class="mt-4" style="display: none;">
                                        <div class="alert alert-info">
                                            <h6 class="mb-2"><i class="bi bi-lightbulb me-2"></i>Script Migration Guidance</h6>
                                            <p class="mb-2 small">Your management pack contains scripts that need migration. Here are your options:</p>
                                            <ul class="mb-0 small">
                                                <li><strong>Azure Functions:</strong> Convert scripts to Azure Functions for serverless execution</li>
                                                <li><strong>Azure Automation:</strong> Use Runbooks for scheduled script execution</li>
                                                <li><strong>Custom Log DCR:</strong> Configure scripts to write to log files collected by Azure Monitor Agent</li>
                                            </ul>
                                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="showScriptDetails()">
                                                <i class="bi bi-code me-1"></i>View Script Details
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Deployment Instructions -->
                                    <div class="mt-4">
                                        <h6 class="mb-3"><i class="bi bi-terminal me-2"></i>How to Deploy</h6>
                                        <div class="accordion" id="deployAccordion">
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#deployPortal">
                                                        <i class="bi bi-window me-2"></i> Deploy via Azure Portal
                                                    </button>
                                                </h2>
                                                <div id="deployPortal" class="accordion-collapse collapse" data-bs-parent="#deployAccordion">
                                                    <div class="accordion-body small">
                                                        <ol class="mb-0">
                                                            <li>Go to <a href="https://portal.azure.com/#create/Microsoft.Template" target="_blank">Azure Portal â†’ Deploy a custom template</a></li>
                                                            <li>Click <strong>"Build your own template in the editor"</strong></li>
                                                            <li>Click <strong>"Load file"</strong> and select the downloaded ARM template</li>
                                                            <li>Click <strong>Save</strong></li>
                                                            <li>Fill in the parameters (workspace name, email for alerts, etc.)</li>
                                                            <li>Select your <strong>subscription</strong> and <strong>resource group</strong></li>
                                                            <li>Click <strong>Review + Create</strong>, then <strong>Create</strong></li>
                                                        </ol>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#deployCLI">
                                                        <i class="bi bi-code-slash me-2"></i> Deploy via Azure CLI
                                                    </button>
                                                </h2>
                                                <div id="deployCLI" class="accordion-collapse collapse" data-bs-parent="#deployAccordion">
                                                    <div class="accordion-body small">
                                                        <pre class="bg-dark text-light p-3 rounded mb-2" style="font-size: 0.75rem;"><code># Login to Azure
az login

# Deploy ARM template (alert rules)
az deployment group create \
  --resource-group YOUR_RESOURCE_GROUP \
  --template-file azuredeploy.json \
  --parameters workspaceName=your-workspace \
               actionGroupEmail=alerts@yourcompany.com

# Deploy DCR template
az deployment group create \
  --resource-group YOUR_RESOURCE_GROUP \
  --template-file data-collection-rules.json \
  --parameters workspaceResourceId=/subscriptions/xxx/resourceGroups/xxx/providers/Microsoft.OperationalInsights/workspaces/xxx

# Deploy Workbook
az deployment group create \
  --resource-group YOUR_RESOURCE_GROUP \
  --template-file monitoring-workbook.json \
  --parameters workspaceResourceId=/subscriptions/xxx/...

# Deploy Custom Log DCR (for script outputs)
az deployment group create \
  --resource-group YOUR_RESOURCE_GROUP \
  --template-file custom-log-dcr.json \
  --parameters workspaceResourceId=/subscriptions/xxx/... \
               customLogPath="C:\\Logs\\*.log"</code></pre>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#deployPS">
                                                        <i class="bi bi-terminal-fill me-2"></i> Deploy via PowerShell
                                                    </button>
                                                </h2>
                                                <div id="deployPS" class="accordion-collapse collapse" data-bs-parent="#deployAccordion">
                                                    <div class="accordion-body small">
                                                        <pre class="bg-dark text-light p-3 rounded mb-2" style="font-size: 0.75rem;"><code># Login to Azure
Connect-AzAccount

# Deploy ARM template
New-AzResourceGroupDeployment `
  -ResourceGroupName "YOUR_RESOURCE_GROUP" `
  -TemplateFile "azuredeploy.json" `
  -workspaceName "your-workspace" `
  -actionGroupEmail "alerts@yourcompany.com"

# Deploy DCR template
New-AzResourceGroupDeployment `
  -ResourceGroupName "YOUR_RESOURCE_GROUP" `
  -TemplateFile "data-collection-rules.json" `
  -workspaceResourceId "/subscriptions/xxx/..."

# Deploy Workbook
New-AzResourceGroupDeployment `
  -ResourceGroupName "YOUR_RESOURCE_GROUP" `
  -TemplateFile "monitoring-workbook.json" `
  -workspaceResourceId "/subscriptions/xxx/..."

# Deploy Custom Log DCR (for script outputs)
New-AzResourceGroupDeployment `
  -ResourceGroupName "YOUR_RESOURCE_GROUP" `
  -TemplateFile "custom-log-dcr.json" `
  -workspaceResourceId "/subscriptions/xxx/..." `
  -customLogPath "C:\Logs\*.log"</code></pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- About the Author -->
                <div class="card author-card mt-4">
                    <div class="card-body p-4">
                        <h6 class="mb-3" style="color: var(--gray-500); font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">
                            <i class="bi bi-person-badge me-1"></i>
                            About the Author
                        </h6>
                        <div>
                            <h6 class="mb-1 fw-bold" style="font-size: 15px;">Oren Salzberg</h6>
                            <p class="small mb-2" style="color: var(--gray-500);">
                                Product Manager â€” Microsoft Azure Log Analytics Team
                            </p>
                            <p class="small mb-2" style="color: var(--gray-600); line-height: 1.6;">
                                Oren is a Product Manager in the Microsoft Azure Log Analytics team with extensive experience in IT monitoring 
                                and operations management. As a former SCOM Premier Field Engineer, he brings deep expertise in System Center 
                                Operations Manager and enterprise monitoring solutions to help organizations optimize their IT infrastructure.
                            </p>
                            <p class="small mb-0">
                                <a href="https://www.linkedin.com/in/oren-salzberg-4b827b57/" target="_blank" rel="noopener noreferrer" 
                                   class="text-decoration-none" style="color: var(--primary);">
                                    <i class="bi bi-linkedin me-1"></i>Connect on LinkedIn
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="footer-section">
                    <div class="footer-text mb-3">
                        <p class="mb-1">
                            <i class="bi bi-shield-check me-1"></i>
                            SCOM to Azure Monitor Migration Tool
                        </p>
                        <small style="color: var(--gray-400);">Community Tool Â· Not Officially Supported</small>
                    </div>
                    <div class="footer-links mb-4">
                        <a href="https://github.com/osalzberg/scom-migrator/issues/new/choose" target="_blank" class="btn btn-sm btn-outline-secondary me-1">
                            <i class="bi bi-bug me-1"></i>Report Issue
                        </a>
                        <a href="https://github.com/osalzberg/scom-migrator/discussions" target="_blank" class="btn btn-sm btn-outline-secondary me-1">
                            <i class="bi bi-chat-dots me-1"></i>Feedback
                        </a>
                        <a href="https://github.com/osalzberg/scom-migrator" target="_blank" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-github me-1"></i>GitHub
                        </a>
                    </div>
                </div>
                
                <!-- Disclaimer -->
                <div class="disclaimer-block">
                    <p class="mb-2">
                        <strong style="color: var(--gray-600);">Disclaimer:</strong> 
                        This web application is provided as-is for informational and educational purposes. 
                        The use of this application and any generated ARM templates, migration reports, or artifacts is at your own risk. 
                        This tool is not officially supported or endorsed by Microsoft Corporation. Microsoft Corporation assumes no 
                        responsibility or liability for the use of this tool or any content generated through it. Users are responsible 
                        for testing and validating all generated templates and configurations in their environment before production deployment.
                    </p>
                    <p class="mb-0" style="font-size: 10px;">
                        <strong>Trademarks:</strong> Microsoft, Azure, Azure Monitor, System Center Operations Manager (SCOM), 
                        Windows, and other product names referenced are trademarks or registered trademarks of Microsoft Corporation 
                        in the United States and/or other countries.
                    </p>
                </div>
            </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedFile = null;
        let analysisResult = null;
        let allMappings = [];
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('dropZone');
            
            if (!dropZone) {
                console.error('Drop zone not found!');
                return;
            }
            
            // Prevent default drag behaviors on the whole document
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.body.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            
            // Highlight drop zone when dragging over it
            dropZone.addEventListener('dragenter', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('dragover');
            }, false);
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('dragover');
            }, false);
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('dragover');
            }, false);
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('dragover');
                
                const dt = e.dataTransfer;
                if (dt && dt.files && dt.files.length > 0) {
                    handleFile(dt.files[0]);
                }
            }, false);
            
            // Click anywhere on the drop zone to open file picker
            dropZone.addEventListener('click', function(e) {
                // Don't trigger if clicking the Browse Files button (it already opens the picker via label)
                if (e.target.closest('label[for="fileInput"]') || e.target.closest('button')) return;
                document.getElementById('fileInput').click();
            });
        });
        
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        function handleFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext !== 'xml') {
                showFileFormatError(ext);
                return;
            }
            
            selectedFile = file;
            document.getElementById('fileName').textContent = file.name + ' (' + formatFileSize(file.size) + ')';
            document.getElementById('selectedFile').style.display = 'block';
            document.getElementById('analyzeBtn').disabled = false;
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function clearFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('selectedFile').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
        }
        
        function analyzeFile() {
            if (!selectedFile) return;
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            
            fetch('/api/analyze', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(response.status === 404 
                        ? 'API endpoint not found. Make sure the app is deployed to Azure or the API is running locally.'
                        : 'Server returned ' + response.status + ' ' + response.statusText);
                }
                const contentType = response.headers.get('content-type') || '';
                if (!contentType.includes('application/json')) {
                    throw new Error('Server returned an unexpected response. Make sure the API is running.');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('loadingSection').style.display = 'none';
                
                if (data.error) {
                    showUserFriendlyError(data.error);
                    document.getElementById('uploadSection').style.display = 'block';
                    return;
                }
                
                analysisResult = data;
                displayResults(data);
            })
            .catch(error => {
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
                showUserFriendlyError(error.toString());
            });
        }
        
        function showUserFriendlyError(errorMsg) {
            // Check for our specific error types and show friendly modal
            if (errorMsg.includes('SEALED_MP:') || errorMsg.includes('MPB_BUNDLE:') || 
                errorMsg.includes('sealed Management Pack') || errorMsg.includes('Management Pack Bundle') ||
                errorMsg.includes('not well-formed') || errorMsg.includes('invalid token')) {
                
                // Show a nice modal instead of alert
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
                
                const isSealed = errorMsg.includes('SEALED_MP:') || errorMsg.includes('sealed');
                const isMPB = errorMsg.includes('MPB_BUNDLE:') || errorMsg.includes('Bundle');
                
                let title = 'ðŸ“¦ Sealed Management Pack Detected';
                let fileType = '.mp file';
                if (isMPB) {
                    title = 'ðŸ“¦ Management Pack Bundle Detected';
                    fileType = '.mpb bundle';
                }
                
                modal.innerHTML = `
                    <div style="background:white;border-radius:var(--radius-lg);padding:32px;max-width:500px;margin:20px;box-shadow:var(--shadow-xl);">
                        <h2 style="margin:0 0 16px 0;color:var(--primary);font-size:20px;font-weight:600;">${title}</h2>
                        <p style="color:var(--gray-700);margin:0 0 20px 0;line-height:1.6;">
                            This ${fileType} cannot be analyzed directly. Please export it as XML from SCOM.
                        </p>
                        <div style="background:var(--gray-50);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
                            <p style="margin:0 0 12px 0;font-weight:600;color:var(--gray-800);">How to export:</p>
                            <ol style="margin:0;padding-left:20px;color:var(--gray-600);line-height:1.8;">
                                <li>Open <strong>SCOM Console</strong></li>
                                <li>Go to <strong>Administration â†’ Management Packs</strong></li>
                                <li>Right-click the MP â†’ <strong>Export Management Pack</strong></li>
                                <li>Save as <strong>.xml</strong> and upload here</li>
                            </ol>
                        </div>
                        <button onclick="this.closest('div').parentElement.remove()" 
                            style="background:var(--primary);color:white;border:none;padding:12px 32px;border-radius:var(--radius-md);cursor:pointer;font-size:14px;font-weight:500;">
                            Got it
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            } else {
                // Generic error - show inline alert instead of browser alert()
                const errorContainer = document.getElementById('uploadSection');
                if (errorContainer) {
                    // Remove any previous inline error
                    const prev = errorContainer.querySelector('.inline-error');
                    if (prev) prev.remove();
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger d-flex align-items-start mt-3 inline-error';
                    errorDiv.innerHTML = `
                        <i class="bi bi-exclamation-triangle-fill me-2 mt-1" style="color: var(--danger);"></i>
                        <div class="flex-grow-1">
                            <strong>Analysis failed</strong>
                            <p class="mb-0 small mt-1" style="color: var(--gray-600);">${errorMsg}</p>
                        </div>
                        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                    `;
                    errorContainer.insertBefore(errorDiv, errorContainer.firstChild);
                }
            }
        }
        
        function showFileFormatError(ext) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
            
            let title = 'ðŸ“¦ Unsupported File Format';
            let description = `You uploaded a <strong>.${ext}</strong> file.`;
            
            if (ext === 'mp') {
                title = 'ðŸ“¦ Sealed Management Pack Detected';
                description = 'Sealed Management Packs (.mp) are compiled and cannot be analyzed directly.';
            } else if (ext === 'mpb') {
                title = 'ðŸ“¦ Management Pack Bundle Detected';
                description = 'Management Pack Bundles (.mpb) cannot be analyzed directly.';
            }
            
            modal.innerHTML = `
                <div style="background:white;border-radius:var(--radius-lg);padding:32px;max-width:500px;margin:20px;box-shadow:var(--shadow-xl);">
                    <h2 style="margin:0 0 16px 0;color:var(--primary);font-size:20px;font-weight:600;">${title}</h2>
                    <p style="color:var(--gray-700);margin:0 0 20px 0;line-height:1.6;">
                        ${description} Please export it as XML from SCOM.
                    </p>
                    <div style="background:var(--gray-50);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;">
                        <p style="margin:0 0 12px 0;font-weight:600;color:var(--gray-800);">How to export:</p>
                        <ol style="margin:0;padding-left:20px;color:var(--gray-600);line-height:1.8;">
                            <li>Open <strong>SCOM Console</strong></li>
                            <li>Go to <strong>Administration â†’ Management Packs</strong></li>
                            <li>Right-click the MP â†’ <strong>Export Management Pack</strong></li>
                            <li>Save as <strong>.xml</strong> and upload here</li>
                        </ol>
                    </div>
                    <button onclick="this.closest('div').parentElement.remove()" 
                        style="background:var(--primary);color:white;border:none;padding:12px 32px;border-radius:var(--radius-md);cursor:pointer;font-size:14px;font-weight:500;">
                        Got it
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }
        
        function displayResults(data) {
            document.getElementById('resultSection').style.display = 'block';
            
            // Show floating download button
            document.getElementById('floatingDownloadBtn').style.display = 'block';
            
            // MP Info
            document.getElementById('mpName').textContent = data.management_pack.display_name || data.management_pack.name;
            document.getElementById('mpVersion').textContent = 'Version: ' + data.management_pack.version;
            
            // Check if there are scripts in the MP - show/hide Script Guide button
            const hasScripts = data.mappings && data.mappings.some(m => 
                m.data_sources && m.data_sources.some(ds => 
                    ds.script_body || ds.type === 'Script' || ds.type === 'PowerShell' || ds.type === 'VBScript'
                )
            );
            document.getElementById('scriptGuideButtonContainer').style.display = hasScripts ? 'block' : 'none';
            
            // Stats with animation
            animateValue('totalComponents', 0, data.total_components, 1000);
            animateValue('migratableCount', 0, data.migratable_components, 1000);
            animateValue('manualCount', 0, data.requires_manual_review, 1000);
            
            // Migration Readiness
            const total = data.total_components || 1;
            const migratable = data.migratable_components || 0;
            const readinessPercent = Math.round((migratable / total) * 100);
            document.getElementById('readinessPercent').textContent = readinessPercent + '%';
            document.getElementById('readinessBar').style.width = readinessPercent + '%';
            
            // Set color based on percentage
            const readinessBar = document.getElementById('readinessBar');
            if (readinessPercent >= 70) {
                readinessBar.className = 'progress-bar bg-success';
                document.getElementById('readinessText').textContent = `${migratable} of ${total} components can be migrated with Simple or Moderate effort`;
            } else if (readinessPercent >= 40) {
                readinessBar.className = 'progress-bar bg-warning';
                document.getElementById('readinessText').textContent = `${migratable} of ${total} components are easily migratable. Plan additional time for the rest.`;
            } else {
                readinessBar.className = 'progress-bar bg-danger';
                document.getElementById('readinessText').textContent = `Only ${migratable} of ${total} components are easily migratable. Consider a phased approach.`;
            }
            
            // Recommendations - display with better formatting
            const recsDiv = document.getElementById('recommendations');
            recsDiv.innerHTML = data.overall_recommendations
                .filter(rec => rec && rec.trim())
                .map(rec => {
                    // Determine card style based on content
                    let cardClass = 'border-start border-primary border-3';
                    let bgClass = 'bg-light';
                    
                    if (rec.includes('âš ï¸') || rec.includes('UNSUPPORTED')) {
                        cardClass = 'border-start border-warning border-3';
                        bgClass = 'bg-warning bg-opacity-10';
                    } else if (rec.includes('ðŸ”´') || rec.includes('Complex migration')) {
                        cardClass = 'border-start border-danger border-3';
                        bgClass = 'bg-danger bg-opacity-10';
                    } else if (rec.includes('âœ…')) {
                        cardClass = 'border-start border-success border-3';
                        bgClass = 'bg-success bg-opacity-10';
                    } else if (rec.includes('ðŸ—ï¸')) {
                        cardClass = 'border-start border-info border-3';
                        bgClass = 'bg-info bg-opacity-10';
                    }
                    
                    // Format bullet points properly
                    let formattedRec = rec
                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n\s+â€¢/g, '<br>&nbsp;&nbsp;â€¢')
                        .replace(/\n\s+(\d+\.)/g, '<br>&nbsp;&nbsp;$1')
                        .replace(/   â€¢/g, '<br>&nbsp;&nbsp;&nbsp;&nbsp;â€¢')
                        .replace(/   (\d+\.)/g, '<br>&nbsp;&nbsp;&nbsp;&nbsp;$1');
                    
                    return `<div class="card mb-2 ${cardClass}">
                        <div class="card-body py-2 px-3 ${bgClass}">
                            <small>${formattedRec}</small>
                        </div>
                    </div>`;
                }).join('');
            
            // Prerequisites
            const prereqList = document.getElementById('prerequisites');
            prereqList.innerHTML = data.prerequisites.slice(0, 10)
                .filter(p => p && p.trim())
                .map(p => 
                    `<li class="mb-1"><i class="bi bi-dash me-2 text-muted"></i>${p}</li>`
                ).join('');
            
            // Mappings - separate easy vs manual
            allMappings = data.mappings;
            displayMappings(allMappings);
            
            // Display easy migrations separately
            const easyMappings = allMappings.filter(m => 
                m.migration_complexity === 'Simple' || m.migration_complexity === 'Moderate'
            );
            const manualMappings = allMappings.filter(m => 
                m.migration_complexity === 'ManualRequired' || m.migration_complexity === 'Complex'
            );
            
            if (easyMappings.length > 0) {
                document.getElementById('easyMigrationCard').style.display = 'block';
                document.getElementById('easyCount').textContent = easyMappings.length;
                document.getElementById('easyMappings').innerHTML = easyMappings.map(m => createMappingCard(m, true)).join('');
            }
            
            if (manualMappings.length > 0) {
                document.getElementById('manualReviewCard').style.display = 'block';
                document.getElementById('manualCount2').textContent = manualMappings.length;
                document.getElementById('manualMappings').innerHTML = manualMappings.map(m => createMappingCard(m, true)).join('');
            }
        }
        
        function animateValue(id, start, end, duration) {
            const element = document.getElementById(id);
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.round(current);
            }, 16);
        }
        
        function createMappingCard(m, showDetails = false) {
            const complexityClass = {
                'Simple': 'success',
                'Moderate': 'warning', 
                'Complex': 'danger',
                'ManualRequired': 'secondary'
            }[m.migration_complexity] || 'secondary';
            
            const recommendations = m.recommendations.map(r => `
                <div class="mb-2">
                    <span class="badge bg-primary badge-target me-2">${escapeHtml(r.target_type)}</span>
                    <span>${escapeHtml(r.description)}</span>
                    ${r.implementation_notes && showDetails ? `
                        <details class="mt-2">
                            <summary class="text-muted small"><strong>ðŸ“‹ Implementation Steps</strong></summary>
                            <div class="mt-2 small p-3 rounded" style="background: var(--gray-50); border-left: 3px solid var(--primary);">${formatNotes(r.implementation_notes)}</div>
                        </details>
                    ` : ''}
                    ${r.kql_query && showDetails ? `
                        <details class="mt-2">
                            <summary class="text-muted small"><strong>ðŸ“Š KQL Query</strong></summary>
                            <div class="kql-code mt-1"><pre class="mb-0">${escapeHtml(r.kql_query)}</pre></div>
                        </details>
                    ` : ''}
                    ${r.prerequisites && r.prerequisites.length > 0 && showDetails ? `
                        <details class="mt-2">
                            <summary class="text-muted small"><strong>âœ… Prerequisites</strong></summary>
                            <ul class="mt-1 small">
                                ${r.prerequisites.map(p => `<li>${escapeHtml(p)}</li>`).join('')}
                            </ul>
                        </details>
                    ` : ''}
                </div>
            `).join('<hr class="my-2">');
            
            const manualSteps = m.manual_steps && m.manual_steps.length > 0 && showDetails ? `
                <div class="mt-3 p-2 bg-warning bg-opacity-10 rounded">
                    <strong class="small"><i class="bi bi-list-check me-1"></i>Migration Steps:</strong>
                    <ol class="small mb-0 mt-1">
                        ${m.manual_steps.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                    </ol>
                </div>
            ` : '';
            
            const migrationNotes = m.migration_notes && m.migration_notes.length > 0 && showDetails ? `
                <div class="mt-2 small text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    ${m.migration_notes.map(n => escapeHtml(n)).join(' | ')}
                </div>
            ` : '';
            
            return `
                <div class="card mapping-card mb-2" data-type="${escapeHtml(m.source_type)}">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge bg-info me-2">${escapeHtml(m.source_type)}</span>
                                <strong>${escapeHtml(m.source_name)}</strong>
                            </div>
                            <span class="badge bg-${complexityClass}">${escapeHtml(m.migration_complexity)}</span>
                        </div>
                        <div class="mt-2">
                            ${recommendations}
                        </div>
                        ${manualSteps}
                        ${migrationNotes}
                        ${m.limitations.length > 0 ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    ${escapeHtml(m.limitations[0])}
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function formatNotes(text) {
            if (!text) return '';
            
            // First, extract and protect code blocks (triple backticks or lines starting with //)
            var codeBlocks = [];
            var result = text;
            
            // Handle triple backtick code blocks
            result = result.replace(/```([\s\S]*?)```/g, function(match, code) {
                var index = codeBlocks.length;
                codeBlocks.push(code.trim());
                return '%%CODEBLOCK' + index + '%%';
            });
            
            // Handle lines that look like code (starting with // or | or contain KQL-like syntax)
            var lines = result.split(/\\n|\n/);
            var inCodeBlock = false;
            var codeBuffer = [];
            var processedLines = [];
            
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                var isCodeLine = line.startsWith('//') || 
                                 line.startsWith('|') || 
                                 line.match(/^(where|summarize|project|extend|join|let|ConfigurationChange|Perf|Event|Heartbeat)\s/i) ||
                                 (inCodeBlock && line.length > 0 && !line.match(/^\d+\.\s/) && !line.startsWith('**'));
                
                if (isCodeLine) {
                    inCodeBlock = true;
                    codeBuffer.push(lines[i]);
                } else {
                    if (codeBuffer.length > 0) {
                        var index = codeBlocks.length;
                        codeBlocks.push(codeBuffer.join('\n'));
                        processedLines.push('%%CODEBLOCK' + index + '%%');
                        codeBuffer = [];
                        inCodeBlock = false;
                    }
                    processedLines.push(lines[i]);
                }
            }
            
            // Don't forget remaining code buffer
            if (codeBuffer.length > 0) {
                var index = codeBlocks.length;
                codeBlocks.push(codeBuffer.join('\n'));
                processedLines.push('%%CODEBLOCK' + index + '%%');
            }
            
            result = processedLines.join('\n');
            
            // Escape HTML
            result = escapeHtml(result);
            
            // Convert markdown-style formatting
            // Headers: **text** -> bold
            result = result.replace(/\*\*([^*]+)\*\*/g, '<strong class="text-primary">$1</strong>');
            
            // Numbered lists: "1. ", "2. " etc at start of line
            result = result.replace(/^(\d+)\.\s+/gm, '<span class="badge bg-primary rounded-circle me-2">$1</span>');
            
            // Bullet points: "â€¢ " or "- " at start of line
            result = result.replace(/^[â€¢\-]\s+/gm, '<i class="bi bi-check-circle text-success me-2"></i>');
            
            // Inline code: `code`
            result = result.replace(/`([^`]+)`/g, '<code class="bg-dark text-light px-1 rounded">$1</code>');
            
            // Line breaks
            result = result.replace(/\\n/g, '</div><div class="mt-2">');
            result = result.replace(/\n/g, '</div><div class="mt-2">');
            
            // Restore code blocks with proper formatting
            for (var i = 0; i < codeBlocks.length; i++) {
                var codeHtml = '<div class="mt-2 mb-2"><pre class="p-3 rounded" style="background: #1e1e1e; color: #d4d4d4; font-family: \'Cascadia Code\', \'Fira Code\', Consolas, monospace; font-size: 0.8rem; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code>' + 
                    escapeHtml(codeBlocks[i]) + 
                    '</code></pre></div>';
                result = result.replace('%%CODEBLOCK' + i + '%%', codeHtml);
            }
            
            // Wrap in container
            result = '<div class="mt-2">' + result + '</div>';
            
            // Clean up empty divs
            result = result.replace(/<div class="mt-2"><\/div>/g, '');
            
            return result;
        }
        
        function displayMappings(mappings) {
            const mappingsDiv = document.getElementById('mappings');
            
            if (mappings.length === 0) {
                mappingsDiv.innerHTML = '<p class="text-muted">No mappings to display</p>';
                return;
            }
            
            mappingsDiv.innerHTML = mappings.map(m => createMappingCard(m, false)).join('');
        }
        
        function filterMappings(type) {
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentFilter = type;
            applyFilters();
        }
        
        let currentFilter = 'all';
        let currentSearch = '';
        
        function searchMappings() {
            currentSearch = document.getElementById('searchMappings').value.toLowerCase();
            applyFilters();
        }
        
        function applyFilters() {
            let filtered = allMappings;
            
            // Apply type filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(m => m.source_type === currentFilter);
            }
            
            // Apply search filter
            if (currentSearch) {
                filtered = filtered.filter(m => 
                    m.source_name.toLowerCase().includes(currentSearch) ||
                    m.source_id.toLowerCase().includes(currentSearch) ||
                    (m.recommendations && m.recommendations.some(r => 
                        r.description && r.description.toLowerCase().includes(currentSearch)
                    ))
                );
            }
            
            displayMappings(filtered);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function resetForm() {
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('floatingDownloadBtn').style.display = 'none';
            clearFile();
            analysisResult = null;
        }
        
        function scrollToDownload() {
            const downloadSection = document.getElementById('downloadSection');
            if (downloadSection) {
                downloadSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Flash effect to highlight the section
                downloadSection.style.transition = 'box-shadow 0.3s ease';
                downloadSection.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.6)';
                setTimeout(() => {
                    downloadSection.style.boxShadow = '';
                }, 1500);
            }
        }
        
        
        function generateCSV() {
            if (!analysisResult || !analysisResult.mappings) return '';
            
            const headers = [
                'Source Type',
                'Source Name', 
                'Migration Complexity',
                'Target Type',
                'Description',
                'KQL Query',
                'Prerequisites',
                'Limitations',
                'Manual Steps'
            ];
            
            const escapeCSV = (str) => {
                if (str === null || str === undefined) return '';
                str = String(str);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };
            
            const rows = analysisResult.mappings.map(m => {
                const rec = m.recommendations && m.recommendations[0] ? m.recommendations[0] : {};
                return [
                    escapeCSV(m.source_type),
                    escapeCSV(m.source_name),
                    escapeCSV(m.migration_complexity),
                    escapeCSV(rec.target_type || ''),
                    escapeCSV(rec.description || ''),
                    escapeCSV(rec.kql_query || ''),
                    escapeCSV((rec.prerequisites || []).join('; ')),
                    escapeCSV((m.limitations || []).join('; ')),
                    escapeCSV((m.manual_steps || []).join('; '))
                ].join(',');
            });
            
            return headers.join(',') + '\n' + rows.join('\n');
        }
        
        function downloadArtifact(type) {
            if (!analysisResult) return;
            
            let content, filename, mimeType = 'application/json';
            
            if (type === 'complete') {
                content = JSON.stringify(analysisResult._complete_template || {}, null, 2);
                filename = 'complete-deployment.json';
            } else if (type === 'arm') {
                content = JSON.stringify(analysisResult._arm_template || {}, null, 2);
                filename = 'azuredeploy.json';
            } else if (type === 'dcr') {
                content = JSON.stringify(analysisResult._dcr_template || {}, null, 2);
                filename = 'data-collection-rules.json';
            } else if (type === 'workbook') {
                content = JSON.stringify(analysisResult._workbook_template || {}, null, 2);
                filename = 'monitoring-workbook.json';
            } else if (type === 'customlog') {
                content = JSON.stringify(analysisResult._custom_log_dcr || {}, null, 2);
                filename = 'custom-log-dcr.json';
            } else if (type === 'report') {
                // Remove internal fields before exporting
                const report = {...analysisResult};
                delete report._arm_template;
                delete report._dcr_template;
                delete report._workbook_template;
                delete report._custom_log_dcr;
                delete report._complete_template;
                content = JSON.stringify(report, null, 2);
                filename = 'migration-report.json';
            } else if (type === 'csv') {
                content = generateCSV();
                filename = 'migration-report.csv';
                mimeType = 'text/csv';
            } else {
                alert('Unknown artifact type');
                return;
            }
            
            // Create and download the file
            const blob = new Blob([content], {type: mimeType});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Script migration guidance functions
        function showScriptGuidance() {
            if (!analysisResult) return;
            
            // Button is only visible when there are scripts, so just show the section
            document.getElementById('scriptGuidanceSection').style.display = 'block';
            document.getElementById('scriptGuidanceSection').scrollIntoView({behavior: 'smooth'});
        }
        
        function showScriptDetails() {
            if (!analysisResult) return;
            
            // Build script details modal content
            let scriptContent = '# Script Migration Details\\n\\n';
            let scriptCount = 0;
            
            analysisResult.mappings.forEach(mapping => {
                if (mapping.data_sources) {
                    mapping.data_sources.forEach(ds => {
                        if (ds.script_body || ds.type === 'Script' || ds.type === 'PowerShell' || ds.type === 'VBScript') {
                            scriptCount++;
                            scriptContent += `## ${mapping.source_name}\\n`;
                            scriptContent += `Type: ${ds.type || 'Unknown'}\\n`;
                            if (ds.script_name) {
                                scriptContent += `Script Name: ${ds.script_name}\\n`;
                            }
                            if (ds.script_body) {
                                scriptContent += `\\n### Script Content:\\n\`\`\`\\n${ds.script_body.substring(0, 500)}${ds.script_body.length > 500 ? '\\n... (truncated)' : ''}\\n\`\`\`\\n\\n`;
                            }
                            scriptContent += '---\\n\\n';
                        }
                    });
                }
            });
            
            if (scriptCount === 0) {
                alert('No scripts with content found.');
                return;
            }
            
            // Download as markdown file
            const blob = new Blob([scriptContent.replace(/\\\\n/g, '\\n')], {type: 'text/markdown'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'script-migration-details.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
